#include "../py/dynruntime.h"

#define SW 80
#define SH 160

const int palette[255] = {0, 0, 0, 655360, 655360, 655360, 1310720, 1310720, 1966336, 1966336, 1966336, 2621952, 2621952, 3277568, 3277568, 3277824, 3998976, 3998976, 4654848, 4654848, 4654848, 5310720, 5310720, 5966336, 5966848, 5966848, 6622464, 6622976, 6622976, 7344128, 7344640, 8000512, 8000512, 8001024, 8656896, 8656896, 9313280, 9313280, 9313280, 10035456, 10035456, 10691328, 10692096, 10692096, 11347968, 11348736, 12004608, 12004608, 12005376, 12661504, 12661504, 13383936, 13383936, 13383936, 14041088, 14041088, 14041088, 14698240, 14698240, 15354368, 15355392, 15355392, 16011520, 16012544, 16734464, 16734464, 16735488, 16737034, 16737034, 16739860, 16739860, 16739860, 16742430, 16742430, 16743976, 16745000, 16745000, 16746291, 16747315, 16747315, 16748861, 16749629, 16751175, 16751175, 16751943, 16753233, 16753233, 16755291, 16755291, 16755291, 16757349, 16757349, 16758640, 16759152, 16759152, 16760442, 16761210, 16762244, 16762244, 16762756, 16764046, 16764046, 16765593, 16765593, 16765593, 16767139, 16767139, 16767139, 16768685, 16768685, 16769719, 16769975, 16769975, 16771009, 16771265, 16772299, 16772299, 16772555, 16773334, 16773334, 16774368, 16774368, 16774368, 16775402, 16775402, 16776180, 16776180, 16776180, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215, 16777215}; 

int fire[SH][SW];


static mp_obj_t setup() {
	for (int y = 0; y < SH; y++) {
		for (int x = 0; x < SW; x++) {
			fire[y][x] = 0;
		}
	}
	return mp_obj_new_int(1);
}

static MP_DEFINE_CONST_FUN_OBJ_0(suobj, setup);

static mp_obj_t pixel(mp_obj_t f_in, mp_obj_t x_in, mp_obj_t y_in) {
	mp_int_t f = mp_obj_get_int(f_in);
	mp_int_t x = mp_obj_get_int(x_in);
	mp_int_t y = mp_obj_get_int(y_in);

	if (y == 0) {
		fire[SH - 1][x] = f;
	}
	fire[y][x] = ((fire[(y + 1) % SH][(x - 1) % SW]
			+ fire[(y + 2) % SH][(x) % SW]
			+ fire[(y + 1) % SH][(x + 1) % SW]
			+ fire[(y + 3) % SH][(x) % SW])
			* 64) / 257;

	return mp_obj_new_int(palette[fire[y][x]]);
}
static MP_DEFINE_CONST_FUN_OBJ_3(fireobj, pixel);


mp_obj_t mpy_init(mp_obj_fun_bc_t *self, size_t n_args, size_t n_kw, mp_obj_t *args) {
	MP_DYNRUNTIME_INIT_ENTRY
	mp_store_global(MP_QSTR_fire, MP_OBJ_FROM_PTR(&fireobj));
	mp_store_global(MP_QSTR_setup, MP_OBJ_FROM_PTR(&suobj));
	MP_DYNRUNTIME_INIT_EXIT
}